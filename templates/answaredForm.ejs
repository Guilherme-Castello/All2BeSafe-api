<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
      :root {
        --color-green: #8bc34a;
        --color-red: #e74c3c;
        --color-blue: #2980b9;
        --color-gray: #95a5a6;
        --bg-section: #eef2f6;
      }

      body {
        font-family: 'Roboto', Arial, sans-serif;
        padding: 20px;
        color: #333;
      }

      h1 {
        text-align: center;
        margin-bottom: 5px;
      }

      .form-meta {
        text-align: center;
        font-size: 0.9em;
        color: #666;
        margin-bottom: 30px;
      }

      .checklist-row {
        display: flex;
        flex-direction: row;
        gap: 15px;
        align-items: center;

        padding: 15px 10px;
        border-bottom: 1px solid #eee;
        font-weight: 500;
      }

      .question-number {
        font-weight: bold;
        width: 10%;
      }

      .question-title {
        width: 40%;
        word-break: break-word;
      }

      .status-box {
        width: 50%;
        text-align: center;
      }

      .status-green { background-color: var(--color-green); }
      .status-red { background-color: var(--color-red); }
      .status-blue { background-color: var(--color-blue); }
      .status-default { background-color: var(--color-gray); }

      .row-extras {
        padding: 10px 10px 20px 10px;
        border-bottom: 1px solid #eee;
      }

      .comment-text {
        margin-bottom: 15px;
        color: #666;
        font-style: italic;
      }

      .photo-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .photo-item img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
    </style>
  </head>

  <body>

    <!-- Cabeçalho -->
    <h1><%= form.config?.name || 'Relatório' %></h1>

    <div class="form-meta">
      <div><strong>Responsável:</strong> <%= form.config?.in_charge || '-' %></div>
      <div><strong>Descrição:</strong> <%= form.config?.description || '-' %></div>
      <div><strong>Respondido por:</strong> <%= answare?.name || '-' %></div>
    </div>
    <!-- Questões -->
    <% if (form.questions && form.questions.length > 0) { %>

      <% form.questions.forEach((q, index) => { 
        const ansObj = getAnswareObj(q.id);
        const ansText = getAnswareText(ansObj, q.kind)
        const colorClass = getColorClass(ansText);
      %>

        <div class="checklist-row">
          <div class="question-number">
            <%= index + 1 %>.
          </div>

          <div class="question-title">
            <%= q.title %>
          </div>

          <div class="status-box <%= colorClass %>">
            <%- ansText %>
          </div>
        </div>

        <% if (ansObj && (ansObj.comment || (ansObj.answare_images && ansObj.answare_images.length))) { %>
          <div class="row-extras">

            <% if (ansObj.comment) { %>
              <div class="comment-text"><%= ansObj.comment %></div>
            <% } %>

            <%- renderAnswareImages(ansObj) %>

          </div>
        <% } %>

      <% }) %>

    <% } else { %>
      <p style="text-align:center">Nenhuma pergunta encontrada.</p>
    <% } %>

    <!-- Assinatura -->
    <% if (answare?.signature) { %>
      <div style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px;">
        <p><strong>Assinatura:</strong></p>
        <img
          src="<%= answare.signature %>"
          alt="Assinatura"
          style="width:250px; border:1px dashed #ccc; padding:5px;"
        />
      </div>
    <% } %>

  </body>

  <%

    function renderAnswareImages(answare) {
      if (
        !answare ||
        !Array.isArray(answare.answare_images) ||
        answare.answare_images.length === 0
      ) {
        return '';
      }

      const imagesHtml = answare.answare_images
        .map(url => `
          <div class="photo-item">
            <img src="${url}" alt="Foto">
          </div>
        `)
        .join('');

      return `
        <div class="photo-container">
          ${imagesHtml}
        </div>
      `;
    }
    
    function getAnswareText(answare, kind) {
      if (
        answare &&
        Array.isArray(answare.answare_checkboxes) &&
        answare.answare_checkboxes.length > 0
      ) {
        return `<p>${answare.answare_checkboxes
          .filter(aBox => aBox.value === true)
          .map(aBox => aBox.label)
          .join(', ')}</p>`;
      }

      if (kind === 'signature' && answare?.answare_text) {
        return `
          <img
            src="${answare.answare_text}"
            alt="Signature"
            style="max-width: 200px; max-height: 100px;"
          />
        `;
      }

      if (
        (kind === 'input_time' || kind === 'input_date') &&
        answare?.answare_text
      ) {
        const date = new Date(answare.answare_text);

        if (isNaN(date.getTime())) return '';

        if (kind === 'input_time') {
          return `<p>${date.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
          })}</p>`;
        }

        if (kind === 'input_date') {
          return `<p>${date.toLocaleDateString('pt-BR')}</p>`;
        }
      }

      return answare?.answare_text ?? '';
    }

    function getAnswareObj(questionId) {
      if (!answare || !answare.answares) return null;
      return answare.answares.find(a =>{
        return a.question_id?.toString() == questionId?.toString()
      });
    }

    function getColorClass(text) {
      if (!text) return 'status-default';

      const t = text.toString().trim().toUpperCase();

      if (['YES', 'SIM', 'OK', 'BOM', 'SEGURO'].includes(t)) return 'status-green';
      if (['NO', 'NÃO', 'RUIM', 'PERIGOSO'].includes(t)) return 'status-red';
      if (['N/A', 'NA', 'N/D'].includes(t)) return 'status-blue';

      return 'status-default';
    }
  %>
</html>
